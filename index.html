<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squadron Schedule</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            font-family: 'JetBrains Mono', monospace;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .event-flying { border-left: 3px solid #10b981; background: rgba(16, 185, 129, 0.1); }
        .event-ground { border-left: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .event-na { border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
        .event-supervision { border-left: 3px solid #8b5cf6; background: rgba(139, 92, 246, 0.1); }
        .event-other { border-left: 3px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }

        .badge-flying { background: #10b981; }
        .badge-ground { background: #f59e0b; }
        .badge-na { background: #ef4444; }
        .badge-supervision { background: #8b5cf6; }
        .badge-other { background: #3b82f6; }

        .status-cancelled { background: #ef4444; opacity: 0.6; text-decoration: line-through; }
        .status-effective { background: transparent; }
        .status-partial { background: #f59e0b; opacity: 0.8; }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body class="text-gray-100 p-4">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        // Default configuration
        const DEFAULT_CONFIG = {
            searchName: 'Sick',
            daysAhead: 4,
            webAppUrl: 'https://script.google.com/macros/s/AKfycbzviTC3JlrGVlKqVTGHhzyfUKfc-9rKLFUgqRpyVKARSJN2CqesnFKe8GEAqXWjw-Tz/exec',
            version: 'enhanced',
            testMode: false,
            testDate: '2025-12-15',
            userRole: 'Regular Personnel', // User's role/category for event filtering
            showGroupEvents: true // Show events marked for "ALL"
        };

        // Available user roles for role-based event visibility
        const USER_ROLES = [
            'Regular Personnel',
            'Staff IP',
            'Staff IFTE/ICSO',
            'STC Staff',
            'Attached/Support'
        ];

        // Role categories that should see STAFF ONLY events
        const STAFF_ROLES = [
            'Staff IP',
            'Staff IFTE/ICSO',
            'STC Staff',
            'Attached/Support'
        ];

        // Load config from localStorage
        const loadConfig = () => {
            try {
                const saved = localStorage.getItem('scheduleWidgetConfig');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    return { ...DEFAULT_CONFIG, ...parsed };
                }
            } catch (e) {
                console.error('Error loading config:', e);
            }
            return DEFAULT_CONFIG;
        };

        // Save config to localStorage
        const saveConfig = (config) => {
            try {
                localStorage.setItem('scheduleWidgetConfig', JSON.stringify(config));
            } catch (e) {
                console.error('Error saving config:', e);
            }
        };

        // Parse event - check for enhanced data first
        const parseEvent = (event) => {
            if (event.enhanced) {
                const enh = event.enhanced;
                const section = enh.section;

                let type, colorClass, badgeClass;

                if (section === 'Flying Events') {
                    type = 'Flying';
                    colorClass = 'event-flying';
                    badgeClass = 'badge-flying';
                } else if (section === 'Ground Events') {
                    type = 'Ground';
                    colorClass = 'event-ground';
                    badgeClass = 'badge-ground';
                } else if (section === 'NA') {
                    type = 'N/A';
                    colorClass = 'event-na';
                    badgeClass = 'badge-na';
                } else if (section === 'Supervision') {
                    type = 'Supervision';
                    colorClass = 'event-supervision';
                    badgeClass = 'badge-supervision';
                } else {
                    type = 'Other';
                    colorClass = 'event-other';
                    badgeClass = 'badge-other';
                }

                return { enhanced: enh, type, colorClass, badgeClass };
            }

            // Fallback: parse legacy format
            const parts = event.description.split('|')
                .map(p => p.trim())
                .filter(p => p && p.toLowerCase() !== 'true' && p.toLowerCase() !== 'false');

            let type = 'Other';
            let colorClass = 'event-other';
            let badgeClass = 'badge-other';

            if (event.rangeSource) {
                const source = event.rangeSource.toLowerCase();
                if (source.includes('flying')) {
                    type = 'Flying';
                    colorClass = 'event-flying';
                    badgeClass = 'badge-flying';
                } else if (source.includes('ground')) {
                    type = 'Ground';
                    colorClass = 'event-ground';
                    badgeClass = 'badge-ground';
                } else if (source.includes('not available')) {
                    type = 'N/A';
                    colorClass = 'event-na';
                    badgeClass = 'badge-na';
                } else if (source.includes('supervision')) {
                    type = 'Supervision';
                    colorClass = 'event-supervision';
                    badgeClass = 'badge-supervision';
                }
            }

            return { parts, type, colorClass, badgeClass };
        };

        // Get display time from event
        const getEventTime = (event) => {
            if (event.enhanced) {
                const enh = event.enhanced;
                if (enh.section === 'Flying Events') return enh.briefStart;
                if (enh.section === 'Ground Events') return enh.start;
                if (enh.section === 'Supervision') return enh.start;
                if (enh.section === 'NA') return enh.start;
            }
            return event.time;
        };

        // Determine event visibility type and who should see it
        const getEventVisibility = (event) => {
            if (!event.enhanced) {
                return { type: 'personal', visibleToRoles: [] };
            }

            const people = event.enhanced.people || [];

            // Check if event is marked for ALL
            const hasAll = people.some(p =>
                p && (p.toUpperCase() === 'ALL' || p.toUpperCase().includes('ALL'))
            );

            if (hasAll) {
                return { type: 'all', visibleToRoles: ['all'] };
            }

            // Check if event is marked as STAFF ONLY
            const hasStaffOnly = people.some(p =>
                p && (p.toUpperCase().includes('STAFF ONLY') || p.toUpperCase().includes('STAFF ON'))
            );

            if (hasStaffOnly) {
                return { type: 'staff-only', visibleToRoles: STAFF_ROLES };
            }

            // Personal event - only for named individuals
            return { type: 'personal', visibleToRoles: [] };
        };

        // Check if user should see this event based on their role
        const shouldShowEvent = (event, userRole, searchName, showGroupEvents) => {
            const visibility = getEventVisibility(event);

            // ALL events - show if user has group events enabled
            if (visibility.type === 'all') {
                return showGroupEvents;
            }

            // STAFF ONLY events - show only if user has a staff role
            if (visibility.type === 'staff-only') {
                return STAFF_ROLES.includes(userRole);
            }

            // Personal events - show if user's name matches
            // This is already handled by the backend search, but we keep the logic here for clarity
            return true;
        };

        // Convert time string to minutes for sorting
        const timeToMinutes = (timeStr) => {
            if (!timeStr) return 9999;
            const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
            if (match) {
                return parseInt(match[1]) * 60 + parseInt(match[2]);
            }
            return 9999;
        };

        // Sort events by time
        const sortEventsByTime = (eventsData) => {
            return eventsData.map(day => ({
                ...day,
                events: [...day.events].sort((a, b) => {
                    return timeToMinutes(getEventTime(a)) - timeToMinutes(getEventTime(b));
                })
            }));
        };

        // Get relative day label
        const getRelativeDay = (dateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            const eventDate = new Date(dateStr + 'T00:00:00');
            eventDate.setHours(0, 0, 0, 0);

            const diffDays = Math.round((eventDate - today) / (1000 * 60 * 60 * 24));

            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays === -1) return 'Yesterday';

            return eventDate.toLocaleDateString('en-US', { weekday: 'long' });
        };

        // Format date for display
        const formatDate = (dateStr, dayName) => {
            const date = new Date(dateStr + 'T00:00:00');
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const day = date.getDate();
            return `${dayName} ${month} ${day}`;
        };

        // Event display component
        function EventCard({ event, dayDate }) {
            const parsed = parseEvent(event);
            const time = getEventTime(event);
            const visibility = getEventVisibility(event);

            // Determine status styling
            let statusClass = '';
            if (parsed.enhanced?.status) {
                if (parsed.enhanced.status.cancelled) {
                    statusClass = 'status-cancelled';
                } else if (parsed.enhanced.status.partiallyEffective) {
                    statusClass = 'status-partial';
                }
            }

            return (
                <div className={`glass-card rounded-lg p-3 ${parsed.colorClass} ${statusClass}`}>
                    {/* Header with time and type */}
                    <div className="flex items-center gap-2 mb-2 flex-wrap">
                        {time && (
                            <span className="text-white font-medium text-sm">{time}</span>
                        )}
                        <span className={`text-xs px-2 py-0.5 rounded ${parsed.badgeClass} text-white`}>
                            {parsed.type}
                        </span>
                        {visibility.type === 'all' && (
                            <span className="text-xs px-2 py-0.5 rounded bg-cyan-600 text-white">
                                ALL
                            </span>
                        )}
                        {visibility.type === 'staff-only' && (
                            <span className="text-xs px-2 py-0.5 rounded bg-purple-600 text-white">
                                STAFF ONLY
                            </span>
                        )}
                        {parsed.enhanced?.status?.cancelled && (
                            <span className="text-xs px-2 py-0.5 rounded bg-red-600 text-white">
                                CANCELLED
                            </span>
                        )}
                        {parsed.enhanced?.status?.partiallyEffective && (
                            <span className="text-xs px-2 py-0.5 rounded bg-orange-600 text-white">
                                PARTIAL
                            </span>
                        )}
                    </div>

                    {/* Enhanced content */}
                    {parsed.enhanced ? (
                        <div className="text-sm space-y-1">
                            {/* Flying Events */}
                            {parsed.enhanced.section === 'Flying Events' && (
                                <>
                                    <div className="text-white font-medium">{parsed.enhanced.model} - {parsed.enhanced.event}</div>
                                    <div className="text-gray-400 text-xs">
                                        ETD: {parsed.enhanced.etd} | ETA: {parsed.enhanced.eta} | Debrief: {parsed.enhanced.debriefEnd}
                                    </div>
                                    {parsed.enhanced.crew.length > 0 && (
                                        <div className="text-gray-300">
                                            Crew: {parsed.enhanced.crew.join(', ')}
                                        </div>
                                    )}
                                    {parsed.enhanced.notes && (
                                        <div className="text-gray-400 text-xs italic">{parsed.enhanced.notes}</div>
                                    )}
                                </>
                            )}

                            {/* Ground Events */}
                            {parsed.enhanced.section === 'Ground Events' && (
                                <>
                                    <div className="text-white font-medium">{parsed.enhanced.event}</div>
                                    <div className="text-gray-400 text-xs">
                                        {parsed.enhanced.start} - {parsed.enhanced.end}
                                    </div>
                                    {parsed.enhanced.people.length > 0 && (
                                        <div className="text-gray-300">
                                            {parsed.enhanced.people.join(', ')}
                                        </div>
                                    )}
                                </>
                            )}

                            {/* Supervision */}
                            {parsed.enhanced.section === 'Supervision' && (
                                <>
                                    <div className="text-white font-medium">{parsed.enhanced.duty}</div>
                                    <div className="text-gray-300">POC: {parsed.enhanced.poc}</div>
                                    {!parsed.enhanced.isAuth && (
                                        <div className="text-gray-400 text-xs">
                                            {parsed.enhanced.start} - {parsed.enhanced.end}
                                        </div>
                                    )}
                                </>
                            )}

                            {/* NA (Non-Availability) */}
                            {parsed.enhanced.section === 'NA' && (
                                <>
                                    <div className="text-white font-medium">{parsed.enhanced.reason}</div>
                                    <div className="text-gray-400 text-xs">
                                        {parsed.enhanced.start} - {parsed.enhanced.end}
                                    </div>
                                    {parsed.enhanced.people.length > 0 && (
                                        <div className="text-gray-300">
                                            {parsed.enhanced.people.join(', ')}
                                        </div>
                                    )}
                                </>
                            )}
                        </div>
                    ) : (
                        /* Legacy fallback */
                        <div className="text-sm text-gray-300">
                            {parsed.parts.map((part, i) => (
                                <span key={i}>
                                    {i > 0 && <span className="text-gray-600 mx-1">•</span>}
                                    {part}
                                </span>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        // Main App Component
        function App() {
            const [config, setConfig] = useState(loadConfig);
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);

            const debounceTimerRef = useRef(null);
            const currentRequestRef = useRef(null);
            const inputNameRef = useRef(config.searchName);

            // Fetch schedule
            const fetchSchedule = useCallback(async (searchName) => {
                if (!searchName || !config.webAppUrl) {
                    setEvents([]);
                    return;
                }

                const requestId = Date.now();
                currentRequestRef.current = requestId;

                setLoading(true);
                setError(null);

                try {
                    // Build URL with parameters
                    let url = `${config.webAppUrl}?name=${encodeURIComponent(searchName)}&days=${config.daysAhead}`;

                    // Add version parameter
                    if (config.version) {
                        url += `&version=${config.version}`;
                    }

                    // Add test date if test mode is enabled
                    if (config.testMode && config.testDate) {
                        url += `&testDate=${config.testDate}`;
                    }

                    url += `&_t=${requestId}`;

                    console.log('Fetching:', url);

                    const response = await fetch(url);

                    if (currentRequestRef.current !== requestId) {
                        console.log('Ignoring stale response');
                        return;
                    }

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    console.log('Received data:', data);

                    if (currentRequestRef.current !== requestId) {
                        console.log('Ignoring stale response (post-parse)');
                        return;
                    }

                    if (data.events) {
                        // Sort events by time
                        const sortedEvents = sortEventsByTime(data.events);

                        // Filter events based on user role and settings
                        const filteredEvents = sortedEvents.map(day => ({
                            ...day,
                            events: day.events.filter(event =>
                                shouldShowEvent(event, config.userRole, config.searchName, config.showGroupEvents)
                            )
                        })).filter(day => day.events.length > 0); // Remove days with no events

                        setEvents(filteredEvents);
                        setLastUpdated(new Date()); // Only update when data is successfully received
                    } else {
                        setEvents([]);
                    }
                } catch (err) {
                    if (currentRequestRef.current === requestId) {
                        console.error('Fetch error:', err);
                        setError(err.message);
                    }
                } finally {
                    if (currentRequestRef.current === requestId) {
                        setLoading(false);
                    }
                }
            }, [config.webAppUrl, config.daysAhead, config.version, config.testMode, config.testDate, config.userRole, config.showGroupEvents]);

            // Debounced fetch
            const debouncedFetch = useCallback((searchName) => {
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }
                debounceTimerRef.current = setTimeout(() => {
                    fetchSchedule(searchName);
                }, 500);
            }, [fetchSchedule]);

            // Handle name change
            const handleNameChange = (newName) => {
                inputNameRef.current = newName;
                const newConfig = { ...config, searchName: newName };
                setConfig(newConfig);
                debouncedFetch(newName);
            };

            // Save settings
            const handleSaveSettings = () => {
                const newConfig = { ...config, searchName: inputNameRef.current };
                saveConfig(newConfig);
                setShowSettings(false);
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }
                fetchSchedule(inputNameRef.current);
            };

            // Initial fetch and auto-refresh
            useEffect(() => {
                fetchSchedule(config.searchName);

                const interval = setInterval(() => {
                    fetchSchedule(config.searchName);
                }, 15 * 60 * 1000);

                return () => {
                    clearInterval(interval);
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                    }
                };
            }, []);

            // Manual refresh
            const handleRefresh = () => {
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }
                fetchSchedule(config.searchName);
            };

            return (
                <div className="max-w-md mx-auto">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <h1 className="text-xl font-semibold text-white">Squadron Schedule</h1>
                        <div className="flex gap-2">
                            <button
                                onClick={handleRefresh}
                                disabled={loading}
                                className="p-2 rounded-lg glass-card hover:bg-white/10 transition-colors disabled:opacity-50"
                                title="Refresh"
                            >
                                {loading ? (
                                    <div className="spinner"></div>
                                ) : (
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                )}
                            </button>
                            <button
                                onClick={() => setShowSettings(!showSettings)}
                                className="p-2 rounded-lg glass-card hover:bg-white/10 transition-colors"
                                title="Settings"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>

                    {/* Settings Panel */}
                    {showSettings && (
                        <div className="glass-card rounded-xl p-4 mb-4 fade-in">
                            <h2 className="text-lg font-medium mb-3">Settings</h2>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Search Name</label>
                                    <input
                                        type="text"
                                        value={config.searchName}
                                        onChange={(e) => handleNameChange(e.target.value)}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                        placeholder="Enter name to search"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Results update as you type</p>
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Days Ahead</label>
                                    <select
                                        value={config.daysAhead}
                                        onChange={(e) => {
                                            const newConfig = { ...config, daysAhead: parseInt(e.target.value) };
                                            setConfig(newConfig);
                                        }}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="1">1 day</option>
                                        <option value="4">4 days</option>
                                        <option value="5">5 days</option>
                                        <option value="7">7 days</option>
                                    </select>
                                </div>

                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Your Role/Category</label>
                                    <select
                                        value={config.userRole}
                                        onChange={(e) => {
                                            const newConfig = { ...config, userRole: e.target.value };
                                            setConfig(newConfig);
                                        }}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                    >
                                        {USER_ROLES.map(role => (
                                            <option key={role} value={role}>{role}</option>
                                        ))}
                                    </select>
                                    <p className="text-xs text-gray-500 mt-1">Determines which STAFF ONLY events you see</p>
                                </div>

                                <div>
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={config.showGroupEvents}
                                            onChange={(e) => {
                                                const newConfig = { ...config, showGroupEvents: e.target.checked };
                                                setConfig(newConfig);
                                            }}
                                            className="w-4 h-4 rounded"
                                        />
                                        <span className="text-sm text-gray-400">Show group events (ALL)</span>
                                    </label>
                                    <p className="text-xs text-gray-500 mt-1 ml-6">Display events marked for everyone</p>
                                </div>

                                <div>
                                    <label className="flex items-center gap-2 cursor-pointer">
                                        <input
                                            type="checkbox"
                                            checked={config.testMode}
                                            onChange={(e) => {
                                                const newConfig = { ...config, testMode: e.target.checked };
                                                setConfig(newConfig);
                                            }}
                                            className="w-4 h-4 rounded"
                                        />
                                        <span className="text-sm text-gray-400">Test Mode (simulate different date)</span>
                                    </label>
                                </div>

                                {config.testMode && (
                                    <div>
                                        <label className="block text-sm text-gray-400 mb-1">Test Date</label>
                                        <input
                                            type="date"
                                            value={config.testDate}
                                            onChange={(e) => {
                                                const newConfig = { ...config, testDate: e.target.value };
                                                setConfig(newConfig);
                                            }}
                                            className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                        />
                                        <p className="text-xs text-gray-500 mt-1">Simulates this date as "today"</p>
                                    </div>
                                )}

                                <button
                                    onClick={handleSaveSettings}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-2 transition-colors"
                                >
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    )}

                    {/* Status Bar */}
                    <div className="flex flex-col gap-1 text-xs text-gray-500 mb-3">
                        <div className="flex items-center justify-between">
                            <span>
                                Showing: <span className="text-blue-400">{config.searchName}</span>
                                {config.testMode && <span className="ml-2 text-orange-400">(Test: {config.testDate})</span>}
                            </span>
                            {lastUpdated && (
                                <span>Updated: {lastUpdated.toLocaleTimeString()}</span>
                            )}
                        </div>
                        <div className="flex items-center gap-2">
                            <span>Role: <span className="text-purple-400">{config.userRole}</span></span>
                            {!config.showGroupEvents && (
                                <span className="text-yellow-400">• Group events hidden</span>
                            )}
                        </div>
                    </div>

                    {/* Error Display */}
                    {error && (
                        <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mb-4 text-red-300">
                            <p className="font-medium">Error loading schedule</p>
                            <p className="text-sm opacity-75">{error}</p>
                        </div>
                    )}

                    {/* Loading State */}
                    {loading && events.length === 0 && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <div className="spinner mx-auto mb-3"></div>
                            <p className="text-gray-400">Loading schedule...</p>
                        </div>
                    )}

                    {/* Events List */}
                    {!loading && events.length === 0 && !error && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <p className="text-gray-400">No events found for "{config.searchName}"</p>
                            <p className="text-sm text-gray-500 mt-2">Try adjusting your search name in settings</p>
                        </div>
                    )}

                    {events.length > 0 && (
                        <div className="space-y-4">
                            {events.map((day, dayIndex) => (
                                <div key={day.date} className="fade-in" style={{ animationDelay: `${dayIndex * 0.1}s` }}>
                                    {/* Day Header */}
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className={`text-sm font-medium px-2 py-0.5 rounded ${
                                            getRelativeDay(day.date) === 'Today'
                                                ? 'bg-green-500/20 text-green-400'
                                                : getRelativeDay(day.date) === 'Tomorrow'
                                                    ? 'bg-blue-500/20 text-blue-400'
                                                    : 'bg-gray-500/20 text-gray-400'
                                        }`}>
                                            {getRelativeDay(day.date)}
                                        </span>
                                        <span className="text-gray-400 text-sm">
                                            {formatDate(day.date, day.dayName)}
                                        </span>
                                        <span className="text-gray-600 text-xs">
                                            ({day.events.length} event{day.events.length !== 1 ? 's' : ''})
                                        </span>
                                    </div>

                                    {/* Events for this day */}
                                    <div className="space-y-2">
                                        {day.events.map((event, eventIndex) => (
                                            <EventCard key={`${day.date}-${eventIndex}`} event={event} dayDate={day.date} />
                                        ))}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}

                    {/* Footer */}
                    <div className="mt-6 text-center text-xs text-gray-600">
                        <p>Auto-refreshes every 15 minutes</p>
                        <p className="mt-1">Add to home screen for quick access</p>
                    </div>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

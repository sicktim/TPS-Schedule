<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Squadron Schedule</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#1a1a2e">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');
        
        * {
            font-family: 'JetBrains Mono', monospace;
        }
        
        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
        }
        
        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .event-flying { border-left: 3px solid #10b981; background: rgba(16, 185, 129, 0.1); }
        .event-ground { border-left: 3px solid #f59e0b; background: rgba(245, 158, 11, 0.1); }
        .event-na { border-left: 3px solid #ef4444; background: rgba(239, 68, 68, 0.1); }
        .event-supervision { border-left: 3px solid #8b5cf6; background: rgba(139, 92, 246, 0.1); }
        .event-other { border-left: 3px solid #3b82f6; background: rgba(59, 130, 246, 0.1); }
        
        .badge-flying { background: #10b981; }
        .badge-ground { background: #f59e0b; }
        .badge-na { background: #ef4444; }
        .badge-supervision { background: #8b5cf6; }
        .badge-other { background: #3b82f6; }
        
        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .fade-in {
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 3px; }
    </style>
</head>
<body class="text-gray-100 p-4">
    <div id="root"></div>
    
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;
        
        // Default configuration
        const DEFAULT_CONFIG = {
            searchName: 'Sick',
            daysAhead: 4, // Changed from 3 to 4 to include today + 3 more days
            webAppUrl: 'https://script.google.com/macros/s/AKfycbxCyvRBsI--rXoYZdsHbdjCvHzLjKUIoDS8tebeWevwg87ULGMFzepM-H73x0JXcSs3/exec'
        };
        
        // Load config from localStorage
        const loadConfig = () => {
            try {
                const saved = localStorage.getItem('scheduleWidgetConfig');
                if (saved) {
                    const parsed = JSON.parse(saved);
                    // Ensure daysAhead is at least 4 to include today
                    if (parsed.daysAhead < 4) {
                        parsed.daysAhead = 4;
                    }
                    return { ...DEFAULT_CONFIG, ...parsed };
                }
            } catch (e) {
                console.error('Error loading config:', e);
            }
            return DEFAULT_CONFIG;
        };
        
        // Save config to localStorage
        const saveConfig = (config) => {
            try {
                localStorage.setItem('scheduleWidgetConfig', JSON.stringify(config));
            } catch (e) {
                console.error('Error saving config:', e);
            }
        };
        
        // Parse event description and determine type
        const parseEventDescription = (description, rangeSource) => {
            const parts = description.split('|')
                .map(p => p.trim())
                .filter(p => {
                    if (!p) return false;
                    const lower = p.toLowerCase();
                    if (lower === 'true' || lower === 'false') return false;
                    return true;
                });
            
            let type = 'other';
            let colorClass = 'event-other';
            let badgeClass = 'badge-other';
            
            if (rangeSource) {
                const source = rangeSource.toLowerCase();
                if (source.includes('flying')) {
                    type = 'Flying';
                    colorClass = 'event-flying';
                    badgeClass = 'badge-flying';
                } else if (source.includes('ground')) {
                    type = 'Ground';
                    colorClass = 'event-ground';
                    badgeClass = 'badge-ground';
                } else if (source.includes('not available') || source.includes('n/a')) {
                    type = 'N/A';
                    colorClass = 'event-na';
                    badgeClass = 'badge-na';
                } else if (source.includes('supervision')) {
                    type = 'Supervision';
                    colorClass = 'event-supervision';
                    badgeClass = 'badge-supervision';
                }
            }
            
            return { parts, type, colorClass, badgeClass };
        };
        
        // Convert time string to minutes for sorting (e.g., "07:30" → 450, "12:00" → 720)
        // Events without times are sorted to the end
        const timeToMinutes = (timeStr) => {
            if (!timeStr) return 9999; // No time = sort to end
            
            // Handle HH:MM format
            const match = timeStr.match(/^(\d{1,2}):(\d{2})$/);
            if (match) {
                const hours = parseInt(match[1], 10);
                const minutes = parseInt(match[2], 10);
                return hours * 60 + minutes;
            }
            
            // Handle HHMM format (e.g., "0730")
            const match4 = timeStr.match(/^(\d{2})(\d{2})$/);
            if (match4) {
                const hours = parseInt(match4[1], 10);
                const minutes = parseInt(match4[2], 10);
                return hours * 60 + minutes;
            }
            
            return 9999; // Unknown format = sort to end
        };
        
        // Sort events within each day by time (earliest first)
        const sortEventsByTime = (eventsData) => {
            return eventsData.map(day => ({
                ...day,
                events: [...day.events].sort((a, b) => {
                    return timeToMinutes(a.time) - timeToMinutes(b.time);
                })
            }));
        };
        
        // Get relative day label
        const getRelativeDay = (dateStr) => {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const eventDate = new Date(dateStr + 'T00:00:00');
            eventDate.setHours(0, 0, 0, 0);
            
            const diffTime = eventDate.getTime() - today.getTime();
            const diffDays = Math.round(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays === 0) return 'Today';
            if (diffDays === 1) return 'Tomorrow';
            if (diffDays === -1) return 'Yesterday';
            
            return eventDate.toLocaleDateString('en-US', { weekday: 'long' });
        };
        
        // Format date for display
        const formatDate = (dateStr, dayName) => {
            const date = new Date(dateStr + 'T00:00:00');
            const month = date.toLocaleDateString('en-US', { month: 'short' });
            const day = date.getDate();
            return `${dayName} ${month} ${day}`;
        };
        
        // Main App Component
        function App() {
            const [config, setConfig] = useState(loadConfig);
            const [events, setEvents] = useState([]);
            const [loading, setLoading] = useState(false);
            const [error, setError] = useState(null);
            const [showSettings, setShowSettings] = useState(false);
            const [lastUpdated, setLastUpdated] = useState(null);
            
            // Refs for debouncing and request cancellation
            const debounceTimerRef = useRef(null);
            const currentRequestRef = useRef(null);
            const inputNameRef = useRef(config.searchName);
            
            // Fetch schedule from web app - with request tracking
            const fetchSchedule = useCallback(async (searchName) => {
                if (!searchName || !config.webAppUrl) {
                    setEvents([]);
                    return;
                }
                
                // Create a unique request ID
                const requestId = Date.now();
                currentRequestRef.current = requestId;
                
                setLoading(true);
                setError(null);
                
                try {
                    //const url = `${config.webAppUrl}?name=${encodeURIComponent(searchName)}&days=${config.daysAhead}&_t=${requestId}`;
                    const url = `${config.webAppUrl}?name=${searchName}&days=${config.daysAhead}&testDate=2024-12-15`;
                    console.log('Fetching:', url);
                    
                    const response = await fetch(url);
                    
                    // Check if this request is still the current one
                    if (currentRequestRef.current !== requestId) {
                        console.log('Ignoring stale response for:', searchName);
                        return;
                    }
                    
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    console.log('Received data:', data);
                    
                    // Double-check this is still the current request
                    if (currentRequestRef.current !== requestId) {
                        console.log('Ignoring stale response (post-parse) for:', searchName);
                        return;
                    }
                    
                    if (data.events) {
                        console.log('Events received from server:');
                        console.log('Search name:', data.searchName);
                        console.log('Number of days:', data.events.length);
                        data.events.forEach(day => {
                            console.log(`  ${day.date} (${day.dayName}): ${day.events.length} events`);
                        });
                        
                        // Sort events within each day by time (earliest first)
                        const sortedEvents = sortEventsByTime(data.events);
                        
                        setEvents(sortedEvents);
                        setLastUpdated(new Date());
                    } else {
                        setEvents([]);
                    }
                } catch (err) {
                    // Only set error if this is still the current request
                    if (currentRequestRef.current === requestId) {
                        console.error('Fetch error:', err);
                        setError(err.message);
                    }
                } finally {
                    // Only clear loading if this is still the current request
                    if (currentRequestRef.current === requestId) {
                        setLoading(false);
                    }
                }
            }, [config.webAppUrl, config.daysAhead]);
            
            // Debounced fetch - waits for user to stop typing
            const debouncedFetch = useCallback((searchName) => {
                // Clear any existing timer
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }
                
                // Set a new timer - wait 500ms after last keystroke
                debounceTimerRef.current = setTimeout(() => {
                    fetchSchedule(searchName);
                }, 500);
            }, [fetchSchedule]);
            
            // Handle name change from settings
            const handleNameChange = (newName) => {
                inputNameRef.current = newName;
                const newConfig = { ...config, searchName: newName };
                setConfig(newConfig);
                // Don't save yet - wait for settings to close or explicit save
                debouncedFetch(newName);
            };
            
            // Save settings and close
            const handleSaveSettings = () => {
                const newConfig = { ...config, searchName: inputNameRef.current };
                saveConfig(newConfig);
                setShowSettings(false);
                // Fetch immediately with final name
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }
                fetchSchedule(inputNameRef.current);
            };
            
            // Initial fetch and auto-refresh
            useEffect(() => {
                fetchSchedule(config.searchName);
                
                // Auto-refresh every 15 minutes
                const interval = setInterval(() => {
                    fetchSchedule(config.searchName);
                }, 15 * 60 * 1000);
                
                return () => {
                    clearInterval(interval);
                    if (debounceTimerRef.current) {
                        clearTimeout(debounceTimerRef.current);
                    }
                };
            }, []);
            
            // Manual refresh
            const handleRefresh = () => {
                if (debounceTimerRef.current) {
                    clearTimeout(debounceTimerRef.current);
                }
                fetchSchedule(config.searchName);
            };
            
            return (
                <div className="max-w-md mx-auto">
                    {/* Header */}
                    <div className="flex items-center justify-between mb-4">
                        <h1 className="text-xl font-semibold text-white">Squadron Schedule</h1>
                        <div className="flex gap-2">
                            <button 
                                onClick={handleRefresh}
                                disabled={loading}
                                className="p-2 rounded-lg glass-card hover:bg-white/10 transition-colors disabled:opacity-50"
                                title="Refresh"
                            >
                                {loading ? (
                                    <div className="spinner"></div>
                                ) : (
                                    <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                                    </svg>
                                )}
                            </button>
                            <button 
                                onClick={() => setShowSettings(!showSettings)}
                                className="p-2 rounded-lg glass-card hover:bg-white/10 transition-colors"
                                title="Settings"
                            >
                                <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                                    <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
                                </svg>
                            </button>
                        </div>
                    </div>
                    
                    {/* Settings Panel */}
                    {showSettings && (
                        <div className="glass-card rounded-xl p-4 mb-4 fade-in">
                            <h2 className="text-lg font-medium mb-3">Settings</h2>
                            <div className="space-y-3">
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Search Name</label>
                                    <input
                                        type="text"
                                        value={config.searchName}
                                        onChange={(e) => handleNameChange(e.target.value)}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                        placeholder="Enter name to search"
                                    />
                                    <p className="text-xs text-gray-500 mt-1">Results update as you type (with brief delay)</p>
                                </div>
                                <div>
                                    <label className="block text-sm text-gray-400 mb-1">Days Ahead</label>
                                    <select
                                        value={config.daysAhead}
                                        onChange={(e) => {
                                            const newConfig = { ...config, daysAhead: parseInt(e.target.value) };
                                            setConfig(newConfig);
                                        }}
                                        className="w-full bg-black/30 border border-white/10 rounded-lg px-3 py-2 text-white focus:outline-none focus:border-blue-500"
                                    >
                                        <option value="4">Today + 3 days</option>
                                        <option value="5">Today + 4 days</option>
                                        <option value="6">Today + 5 days</option>
                                        <option value="8">Today + 7 days</option>
                                    </select>
                                </div>
                                <button
                                    onClick={handleSaveSettings}
                                    className="w-full bg-blue-600 hover:bg-blue-700 text-white rounded-lg py-2 transition-colors"
                                >
                                    Save Settings
                                </button>
                            </div>
                        </div>
                    )}
                    
                    {/* Status Bar */}
                    <div className="flex items-center justify-between text-xs text-gray-500 mb-3">
                        <span>Showing events for: <span className="text-blue-400">{config.searchName}</span></span>
                        {lastUpdated && (
                            <span>Updated: {lastUpdated.toLocaleTimeString()}</span>
                        )}
                    </div>
                    
                    {/* Error Display */}
                    {error && (
                        <div className="bg-red-500/20 border border-red-500/50 rounded-xl p-4 mb-4 text-red-300">
                            <p className="font-medium">Error loading schedule</p>
                            <p className="text-sm opacity-75">{error}</p>
                        </div>
                    )}
                    
                    {/* Loading State */}
                    {loading && events.length === 0 && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <div className="spinner mx-auto mb-3"></div>
                            <p className="text-gray-400">Loading schedule...</p>
                        </div>
                    )}
                    
                    {/* Events List */}
                    {!loading && events.length === 0 && !error && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <p className="text-gray-400">No events found for "{config.searchName}"</p>
                            <p className="text-sm text-gray-500 mt-2">Try adjusting your search name in settings</p>
                        </div>
                    )}
                    
                    {events.length > 0 && (
                        <div className="space-y-4">
                            {events.map((day, dayIndex) => (
                                <div key={day.date} className="fade-in" style={{ animationDelay: `${dayIndex * 0.1}s` }}>
                                    {/* Day Header */}
                                    <div className="flex items-center gap-2 mb-2">
                                        <span className={`text-sm font-medium px-2 py-0.5 rounded ${
                                            getRelativeDay(day.date) === 'Today' 
                                                ? 'bg-green-500/20 text-green-400' 
                                                : getRelativeDay(day.date) === 'Tomorrow'
                                                    ? 'bg-blue-500/20 text-blue-400'
                                                    : 'bg-gray-500/20 text-gray-400'
                                        }`}>
                                            {getRelativeDay(day.date)}
                                        </span>
                                        <span className="text-gray-400 text-sm">
                                            {formatDate(day.date, day.dayName)}
                                        </span>
                                        <span className="text-gray-600 text-xs">
                                            ({day.events.length} event{day.events.length !== 1 ? 's' : ''})
                                        </span>
                                    </div>
                                    
                                    {/* Events for this day */}
                                    <div className="space-y-2">
                                        {day.events.map((event, eventIndex) => {
                                            const { parts, type, colorClass, badgeClass } = parseEventDescription(
                                                event.description,
                                                event.rangeSource
                                            );
                                            
                                            return (
                                                <div 
                                                    key={`${day.date}-${eventIndex}`}
                                                    className={`glass-card rounded-lg p-3 ${colorClass}`}
                                                >
                                                    <div className="flex items-start justify-between gap-2">
                                                        <div className="flex-1 min-w-0">
                                                            <div className="flex items-center gap-2 mb-1">
                                                                {event.time && (
                                                                    <span className="text-white font-medium">{event.time}</span>
                                                                )}
                                                                <span className={`text-xs px-1.5 py-0.5 rounded ${badgeClass} text-white`}>
                                                                    {type}
                                                                </span>
                                                            </div>
                                                            <div className="text-sm text-gray-300">
                                                                {parts.map((part, i) => (
                                                                    <span key={i}>
                                                                        {i > 0 && <span className="text-gray-600 mx-1">•</span>}
                                                                        {part}
                                                                    </span>
                                                                ))}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            ))}
                        </div>
                    )}
                    
                    {/* Footer */}
                    <div className="mt-6 text-center text-xs text-gray-600">
                        <p>Auto-refreshes every 15 minutes</p>
                        <p className="mt-1">Add to home screen for quick access</p>
                    </div>
                </div>
            );
        }
        
        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>

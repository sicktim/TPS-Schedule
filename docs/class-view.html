<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TPS Class Schedule</title>
    <meta name="theme-color" content="#1a1a2e">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&display=swap');

        * {
            font-family: 'JetBrains Mono', monospace;
        }

        body {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f0f23 100%);
            min-height: 100vh;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Event type colors */
        .event-flying { background: rgba(16, 185, 129, 0.8); border-color: #10b981; }
        .event-ground { background: rgba(245, 158, 11, 0.8); border-color: #f59e0b; }
        .event-na { background: rgba(239, 68, 68, 0.8); border-color: #ef4444; }
        .event-supervision { background: rgba(139, 92, 246, 0.8); border-color: #8b5cf6; }
        .event-other { background: rgba(59, 130, 246, 0.8); border-color: #3b82f6; }

        .spinner {
            border: 2px solid rgba(255, 255, 255, 0.1);
            border-top: 2px solid #3b82f6;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Gantt grid */
        .gantt-grid {
            display: grid;
            grid-template-columns: 140px repeat(5, 1fr);
            gap: 1px;
            background: rgba(255, 255, 255, 0.1);
        }

        .gantt-cell {
            background: rgba(15, 15, 35, 0.9);
            min-height: 50px;
            padding: 4px;
            position: relative;
        }

        .gantt-header {
            background: rgba(30, 30, 60, 0.9);
            font-weight: 600;
            text-align: center;
            padding: 12px 8px;
        }

        .gantt-name {
            background: rgba(30, 30, 60, 0.9);
            font-weight: 500;
            display: flex;
            align-items: center;
            padding: 8px;
            font-size: 0.75rem;
        }

        .event-block {
            border-radius: 3px;
            padding: 2px 4px;
            margin: 1px 0;
            font-size: 0.65rem;
            line-height: 1.2;
            border-left: 2px solid;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .event-block:hover {
            white-space: normal;
            z-index: 10;
            position: relative;
        }

        /* Multi-select dropdown */
        .multi-select {
            position: relative;
            z-index: 100;
        }

        .multi-select-trigger {
            min-width: 200px;
            text-align: left;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .multi-select-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1f2937;
            border: 1px solid #374151;
            border-radius: 0.5rem;
            margin-top: 4px;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
        }

        .multi-select-option {
            display: flex;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.15s;
        }

        .multi-select-option:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .multi-select-option input {
            margin-right: 8px;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: rgba(255,255,255,0.05); }
        ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.2); border-radius: 4px; }

        /* Print styles */
        @media print {
            body { background: white; }
            .glass-card { background: white; border: 1px solid #ccc; }
            .gantt-cell, .gantt-header, .gantt-name { background: white; border: 1px solid #ddd; }
            .no-print { display: none; }
        }
    </style>
</head>
<body class="text-gray-100 p-4">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useCallback, useRef } = React;

        const API_URL = 'https://script.google.com/macros/s/AKfycbyS4XcUEFL8P2wDTUywJc4s_kAAIfss0JHmShgdNVYWguDItWZsc9HWaQfiv4nZPt0N/exec';

        // Day abbreviations
        const DAY_ABBREV = ['Mon', 'Tue', 'Wed', 'Thu', 'Fri'];

        // Multi-select dropdown component
        function MultiSelect({ options, selected, onChange, placeholder }) {
            const [isOpen, setIsOpen] = useState(false);
            const dropdownRef = useRef(null);

            // Close dropdown when clicking outside
            useEffect(() => {
                const handleClickOutside = (event) => {
                    if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
                        setIsOpen(false);
                    }
                };
                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
            }, []);

            const toggleOption = (option) => {
                if (selected.includes(option)) {
                    onChange(selected.filter(s => s !== option));
                } else {
                    onChange([...selected, option]);
                }
            };

            const selectAll = () => {
                onChange([...options]);
            };

            const clearAll = () => {
                onChange([]);
            };

            const displayText = selected.length === 0
                ? placeholder
                : selected.length === options.length
                    ? 'All Selected'
                    : `${selected.length} selected`;

            return (
                <div className="multi-select" ref={dropdownRef}>
                    <button
                        type="button"
                        onClick={() => setIsOpen(!isOpen)}
                        className="multi-select-trigger bg-gray-800 border border-gray-600 rounded-lg px-4 py-2 text-white focus:outline-none focus:border-blue-500"
                    >
                        <span>{displayText}</span>
                        <svg className={`w-4 h-4 ml-2 transition-transform ${isOpen ? 'rotate-180' : ''}`} fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M19 9l-7 7-7-7" />
                        </svg>
                    </button>

                    {isOpen && (
                        <div className="multi-select-dropdown">
                            <div className="flex gap-2 p-2 border-b border-gray-700">
                                <button
                                    onClick={selectAll}
                                    className="text-xs px-2 py-1 bg-blue-600 rounded hover:bg-blue-700"
                                >
                                    Select All
                                </button>
                                <button
                                    onClick={clearAll}
                                    className="text-xs px-2 py-1 bg-gray-600 rounded hover:bg-gray-700"
                                >
                                    Clear
                                </button>
                            </div>
                            {options.map(option => (
                                <label key={option} className="multi-select-option">
                                    <input
                                        type="checkbox"
                                        checked={selected.includes(option)}
                                        onChange={() => toggleOption(option)}
                                        className="rounded"
                                    />
                                    <span>{option}</span>
                                </label>
                            ))}
                        </div>
                    )}
                </div>
            );
        }

        function App() {
            const [allData, setAllData] = useState(null);
            const [categories, setCategories] = useState([]);
            const [selectedCategories, setSelectedCategories] = useState([]);
            const [loading, setLoading] = useState(true);
            const [error, setError] = useState(null);
            const [weekDates, setWeekDates] = useState([]);
            const [cacheMetadata, setCacheMetadata] = useState(null);

            // Format date as YYYY-MM-DD in local timezone (not UTC)
            const formatDateLocal = (date) => {
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            };

            // Get current week's dates (Mon-Fri)
            const getWeekDates = useCallback(() => {
                const now = new Date();
                const dayOfWeek = now.getDay();
                const monday = new Date(now);

                // Adjust to Monday (if Sunday, go back 6 days; otherwise go back to previous Monday)
                const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1;
                monday.setDate(now.getDate() - daysFromMonday);

                const dates = [];
                for (let i = 0; i < 5; i++) {
                    const date = new Date(monday);
                    date.setDate(monday.getDate() + i);
                    dates.push({
                        date: date,
                        dateStr: formatDateLocal(date),
                        display: `${DAY_ABBREV[i]} ${date.getMonth() + 1}/${date.getDate()}`
                    });
                }
                return dates;
            }, []);

            // Fetch all data in bulk
            const fetchBulkData = useCallback(async () => {
                setLoading(true);
                setError(null);

                try {
                    const dates = getWeekDates();
                    setWeekDates(dates);

                    const response = await fetch(`${API_URL}?viewCache=bulk`);
                    const data = await response.json();

                    if (data.error) {
                        throw new Error(data.message || 'Failed to fetch data');
                    }

                    setAllData(data);
                    setCacheMetadata(data.metadata);

                    // Set categories from data
                    if (data.categories && data.categories.length > 0) {
                        setCategories(data.categories);
                        // Default: select first category if none selected
                        if (selectedCategories.length === 0) {
                            setSelectedCategories([data.categories[0]]);
                        }
                    }
                } catch (err) {
                    console.error('Error fetching bulk data:', err);
                    setError(err.message);
                } finally {
                    setLoading(false);
                }
            }, [getWeekDates]);

            // Load data on mount
            useEffect(() => {
                fetchBulkData();
            }, []);

            // Get filtered and sorted people
            const getFilteredPeople = useCallback(() => {
                if (!allData || !allData.schedules) return [];

                return allData.schedules
                    .filter(person => selectedCategories.includes(person.category))
                    .sort((a, b) => a.name.localeCompare(b.name));
            }, [allData, selectedCategories]);

            // Get events for a person on a specific date
            const getEventsForDate = (person, dateStr) => {
                if (!person.events) return [];

                let events = [];

                if (Array.isArray(person.events)) {
                    if (person.events.length > 0 && person.events[0].events) {
                        // Grouped by day: [{date, dayName, events: [...]}]
                        const dayData = person.events.find(d => d.date === dateStr);
                        events = dayData ? dayData.events : [];
                    } else {
                        // Flat array: [{date, time, ...}]
                        events = person.events.filter(e => e.date === dateStr);
                    }
                }

                // Sort by time
                events.sort((a, b) => {
                    const timeA = a.time || a.startTime || '';
                    const timeB = b.time || b.startTime || '';
                    return timeA.localeCompare(timeB);
                });

                return events;
            };

            // Get event type class
            const getEventTypeClass = (event) => {
                const type = (event.type || event.eventType || '').toLowerCase();
                if (type.includes('fly') || type.includes('flight')) return 'event-flying';
                if (type.includes('ground')) return 'event-ground';
                if (type.includes('na') || type.includes('unavail')) return 'event-na';
                if (type.includes('super') || type.includes('supe')) return 'event-supervision';
                return 'event-other';
            };

            // Format event display
            const formatEvent = (event) => {
                const time = event.time || event.startTime || '';
                const title = event.title || event.event || event.description || '';
                const shortTime = time.replace(':00', '').replace(' ', '');
                return `${shortTime} ${title}`;
            };

            // Render event block
            const EventBlock = ({ event }) => {
                const typeClass = getEventTypeClass(event);
                const display = formatEvent(event);

                return (
                    <div
                        className={`event-block ${typeClass}`}
                        title={`${event.time || ''} - ${event.title || event.event || ''}\n${event.location || ''}`}
                    >
                        {display}
                    </div>
                );
            };

            const filteredPeople = getFilteredPeople();

            return (
                <div className="max-w-full mx-auto">
                    {/* Header - needs high z-index because backdrop-filter creates stacking context */}
                    <div className="glass-card rounded-xl p-4 mb-4 no-print" style={{ overflow: 'visible', position: 'relative', zIndex: 50 }}>
                        <div className="flex flex-wrap items-center justify-between gap-4" style={{ overflow: 'visible' }}>
                            <div>
                                <h1 className="text-xl font-semibold text-white">TPS Class Schedule</h1>
                                <p className="text-gray-400 text-sm">Weekly Gantt View</p>
                            </div>

                            <div className="flex flex-wrap items-center gap-4">
                                <MultiSelect
                                    options={categories}
                                    selected={selectedCategories}
                                    onChange={setSelectedCategories}
                                    placeholder="Select categories..."
                                />

                                <button
                                    onClick={fetchBulkData}
                                    disabled={loading}
                                    className="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg transition-colors disabled:opacity-50"
                                >
                                    {loading ? 'Loading...' : 'Refresh'}
                                </button>

                                <button
                                    onClick={() => window.print()}
                                    className="px-4 py-2 bg-gray-600 hover:bg-gray-700 rounded-lg transition-colors"
                                >
                                    Print
                                </button>

                                <a
                                    href="index.html"
                                    className="px-4 py-2 bg-gray-700 hover:bg-gray-600 rounded-lg transition-colors"
                                >
                                    Individual View
                                </a>
                            </div>
                        </div>

                        {cacheMetadata && (
                            <div className="mt-2 text-xs text-gray-500">
                                Cache updated: {new Date(cacheMetadata.lastRun).toLocaleString()}
                                {allData && ` | ${allData.peopleCount} people loaded`}
                            </div>
                        )}

                        {selectedCategories.length > 0 && (
                            <div className="mt-2 flex flex-wrap gap-2">
                                {selectedCategories.map(cat => (
                                    <span key={cat} className="text-xs bg-blue-600/30 px-2 py-1 rounded">
                                        {cat}
                                    </span>
                                ))}
                            </div>
                        )}
                    </div>

                    {/* Loading state */}
                    {loading && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <div className="spinner mx-auto mb-4"></div>
                            <p className="text-gray-400">Loading all schedules...</p>
                        </div>
                    )}

                    {/* Error state */}
                    {error && (
                        <div className="glass-card rounded-xl p-8 text-center border border-red-500/50">
                            <p className="text-red-400">Error: {error}</p>
                        </div>
                    )}

                    {/* No selection state */}
                    {!loading && !error && selectedCategories.length === 0 && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <p className="text-gray-400">Select one or more categories to view schedules</p>
                        </div>
                    )}

                    {/* No data state */}
                    {!loading && !error && selectedCategories.length > 0 && filteredPeople.length === 0 && (
                        <div className="glass-card rounded-xl p-8 text-center">
                            <p className="text-gray-400">No people found for selected categories</p>
                        </div>
                    )}

                    {/* Gantt Chart */}
                    {!loading && !error && filteredPeople.length > 0 && (
                        <div className="glass-card rounded-xl overflow-hidden">
                            <div className="overflow-x-auto">
                                <div className="gantt-grid" style={{ minWidth: '900px' }}>
                                    {/* Header row */}
                                    <div className="gantt-header">Name</div>
                                    {weekDates.map((day, i) => (
                                        <div key={i} className="gantt-header">
                                            {day.display}
                                        </div>
                                    ))}

                                    {/* Data rows */}
                                    {filteredPeople.map((person) => (
                                        <React.Fragment key={person.name}>
                                            <div className="gantt-name">
                                                {person.name}
                                            </div>
                                            {weekDates.map((day, colIdx) => {
                                                const events = getEventsForDate(person, day.dateStr);
                                                return (
                                                    <div key={colIdx} className="gantt-cell">
                                                        {events.map((event, eventIdx) => (
                                                            <EventBlock key={eventIdx} event={event} />
                                                        ))}
                                                    </div>
                                                );
                                            })}
                                        </React.Fragment>
                                    ))}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Legend */}
                    {!loading && filteredPeople.length > 0 && (
                        <div className="glass-card rounded-xl p-4 mt-4 no-print">
                            <div className="flex flex-wrap gap-4 text-sm">
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded event-flying"></div>
                                    <span>Flight</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded event-ground"></div>
                                    <span>Ground</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded event-na"></div>
                                    <span>N/A</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded event-supervision"></div>
                                    <span>Supervision</span>
                                </div>
                                <div className="flex items-center gap-2">
                                    <div className="w-4 h-4 rounded event-other"></div>
                                    <span>Other</span>
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>
</html>
